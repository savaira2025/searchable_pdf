<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searchable PDF Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .header {
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e5e5;
        }
        .document-card {
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .document-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .search-results {
            margin-top: 2rem;
        }
        .highlight {
            background-color: #ffffcc;
            padding: 0.2rem;
        }
        #uploadProgress {
            display: none;
        }
        .tab-content {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.25rem 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Searchable PDF Library</h1>
            <p class="lead">Upload, search, and analyze PDF documents</p>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="true">Upload</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab" aria-controls="documents" aria-selected="false">Documents</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab" aria-controls="search" aria-selected="false">Search</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Upload Tab -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
                <div class="row">
                    <div class="col-md-6">
                        <h3>Upload PDF Document</h3>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="pdfFile" class="form-label">Select PDF File</label>
                                <input class="form-control" type="file" id="pdfFile" accept=".pdf" required>
                            </div>
                            <div class="mb-3">
                                <label for="collection" class="form-label">Collection (optional)</label>
                                <input type="text" class="form-control" id="collection" placeholder="e.g., research, legal, finance">
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        <div class="progress mt-3" id="uploadProgress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="uploadResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Documents Tab -->
            <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                <h3>Document Library</h3>
                <div class="mb-3">
                    <label for="collectionFilter" class="form-label">Filter by Collection</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="collectionFilter" placeholder="Collection name">
                        <button class="btn btn-outline-secondary" type="button" id="applyFilter">Apply</button>
                        <button class="btn btn-outline-secondary" type="button" id="clearFilter">Clear</button>
                    </div>
                </div>
                <div class="row" id="documentsList">
                    <p>Loading documents...</p>
                </div>
                <nav aria-label="Documents pagination">
                    <ul class="pagination" id="documentsPagination"></ul>
                </nav>
            </div>
            
            <!-- Search Tab -->
            <div class="tab-pane fade" id="search" role="tabpanel" aria-labelledby="search-tab">
                <h3>Search Documents</h3>
                <form id="searchForm">
                    <div class="mb-3">
                        <label for="searchQuery" class="form-label">Search Query</label>
                        <input type="text" class="form-control" id="searchQuery" placeholder="Enter search terms" required>
                    </div>
                    <div class="mb-3">
                        <label for="searchCollection" class="form-label">Collection (optional)</label>
                        <input type="text" class="form-control" id="searchCollection" placeholder="Filter by collection">
                    </div>
                    <button type="submit" class="btn btn-primary">Search</button>
                </form>
                <div class="search-results">
                    <h4 id="searchResultsHeading" style="display: none;">Search Results</h4>
                    <div id="searchResults"></div>
                    <nav aria-label="Search results pagination">
                        <ul class="pagination" id="searchPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Document Detail Modal -->
        <div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="documentModalLabel">Document Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="documentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata" type="button" role="tab" aria-controls="metadata" aria-selected="true">Metadata</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab" aria-controls="text" aria-selected="false">Text</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tables-tab" data-bs-toggle="tab" data-bs-target="#tables" type="button" role="tab" aria-controls="tables" aria-selected="false">Tables</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="figures-tab" data-bs-toggle="tab" data-bs-target="#figures" type="button" role="tab" aria-controls="figures" aria-selected="false">Figures</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="false">Summary</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="entities-tab" data-bs-toggle="tab" data-bs-target="#entities" type="button" role="tab" aria-controls="entities" aria-selected="false">Entities</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="translation-tab" data-bs-toggle="tab" data-bs-target="#translation" type="button" role="tab" aria-controls="translation" aria-selected="false">Translation</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="documentTabContent">
                            <div class="tab-pane fade show active" id="metadata" role="tabpanel" aria-labelledby="metadata-tab">
                                <div id="documentMetadata"></div>
                            </div>
                            <div class="tab-pane fade" id="text" role="tabpanel" aria-labelledby="text-tab">
                                <div class="mb-3">
                                    <label for="pageRange" class="form-label">Pages (e.g., "1,3,5-7")</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pageRange" placeholder="All pages">
                                        <button class="btn btn-outline-secondary" type="button" id="extractText">Extract</button>
                                    </div>
                                </div>
                                <div id="documentText" class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                            <div class="tab-pane fade" id="tables" role="tabpanel" aria-labelledby="tables-tab">
                                <div class="mb-3">
                                    <label for="tablePageRange" class="form-label">Pages (e.g., "1,3,5-7")</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="tablePageRange" placeholder="All pages">
                                        <select class="form-select" id="tableFormat" style="max-width: 120px;">
                                            <option value="json">JSON</option>
                                            <option value="csv">CSV</option>
                                            <option value="excel">Excel</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="extractTables">Extract</button>
                                    </div>
                                </div>
                                <div id="documentTables"></div>
                            </div>
                            <div class="tab-pane fade" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                                <div class="mb-3">
                                    <label for="summaryLength" class="form-label">Maximum Length</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="summaryLength" value="500" min="100" max="2000">
                                        <button class="btn btn-outline-secondary" type="button" id="generateSummary">Generate</button>
                                    </div>
                                </div>
                                <div id="documentSummary" class="border p-3 bg-light"></div>
                            </div>
                            <div class="tab-pane fade" id="figures" role="tabpanel" aria-labelledby="figures-tab">
                                <div class="mb-3">
                                    <label for="figurePageRange" class="form-label">Pages (e.g., "1,3,5-7")</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="figurePageRange" placeholder="All pages">
                                        <select class="form-select" id="figureFormat" style="max-width: 120px;">
                                            <option value="json">JSON</option>
                                            <option value="zip">ZIP</option>
                                        </select>
                                        <select class="form-select" id="imageFormat" style="max-width: 120px;">
                                            <option value="jpg">JPG</option>
                                            <option value="png">PNG</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="extractFigures">Extract</button>
                                    </div>
                                </div>
                                <div id="documentFigures" class="row"></div>
                            </div>
                            <div class="tab-pane fade" id="entities" role="tabpanel" aria-labelledby="entities-tab">
                                <button class="btn btn-outline-secondary mb-3" type="button" id="extractEntities">Extract Entities</button>
                                <div id="documentEntities"></div>
                            </div>
                            <div class="tab-pane fade" id="translation" role="tabpanel" aria-labelledby="translation-tab">
                                <div class="mb-3">
                                    <label for="translateLanguage" class="form-label">Target Language</label>
                                    <div class="input-group">
                                        <select class="form-select" id="translateLanguage">
                                            <option value="en">English</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                            <option value="de">German</option>
                                            <option value="zh">Chinese</option>
                                            <option value="ja">Japanese</option>
                                            <option value="ru">Russian</option>
                                            <option value="ar">Arabic</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="translateDocument">Translate Document</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="translatePageRange" class="form-label">Pages (e.g., "1,3,5-7")</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="translatePageRange" placeholder="All pages">
                                        <button class="btn btn-outline-secondary" type="button" id="translatePages">Translate Pages</button>
                                    </div>
                                </div>
                                <div id="documentTranslation" class="border p-3 bg-light" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" id="deleteDocument">Delete Document</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API base URL
        const API_BASE_URL = window.location.protocol + '//' + window.location.hostname + ':' + (window.location.port || '8000');
        
        // Current document ID for modal
        let currentDocumentId = null;
        
        // Current page for document list
        let currentDocumentsPage = 1;
        let currentSearchPage = 1;
        
        // Document to show when modal is opened
        document.addEventListener('DOMContentLoaded', function() {
            // Load documents on page load
            loadDocuments();
            
            // Upload form submission
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadDocument();
            });
            
            // Apply collection filter
            document.getElementById('applyFilter').addEventListener('click', function() {
                currentDocumentsPage = 1;
                loadDocuments();
            });
            
            // Clear collection filter
            document.getElementById('clearFilter').addEventListener('click', function() {
                document.getElementById('collectionFilter').value = '';
                currentDocumentsPage = 1;
                loadDocuments();
            });
            
            // Search form submission
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentSearchPage = 1;
                searchDocuments();
            });
            
            // Document modal actions
            document.getElementById('extractText').addEventListener('click', function() {
                extractText();
            });
            
            document.getElementById('extractTables').addEventListener('click', function() {
                extractTables();
            });
            
            document.getElementById('generateSummary').addEventListener('click', function() {
                generateSummary();
            });
            
            document.getElementById('extractFigures').addEventListener('click', function() {
                extractFigures();
            });
            
            document.getElementById('extractEntities').addEventListener('click', function() {
                extractEntities();
            });
            
            document.getElementById('deleteDocument').addEventListener('click', function() {
                deleteDocument();
            });
            
            document.getElementById('translateDocument').addEventListener('click', function() {
                translateDocument();
            });
            
            document.getElementById('translatePages').addEventListener('click', function() {
                translatePages();
            });
            
            // Switch to documents tab when a document is uploaded
            const tabTriggerList = [].slice.call(document.querySelectorAll('#myTab button'));
            const tabList = tabTriggerList.map(function (tabTriggerEl) {
                return new bootstrap.Tab(tabTriggerEl);
            });
            
            // Show documents tab after upload
            document.getElementById('uploadForm').addEventListener('submit', function() {
                setTimeout(function() {
                    tabList[1].show(); // Switch to documents tab
                }, 1000);
            });
        });
        
        // Upload a document
        function uploadDocument() {
            const fileInput = document.getElementById('pdfFile');
            const collection = document.getElementById('collection').value;
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            const uploadResult = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                uploadResult.innerHTML = '<div class="alert alert-danger">Please select a PDF file</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (collection) {
                formData.append('collection', collection);
            }
            
            // Show progress bar
            document.getElementById('uploadProgress').style.display = 'block';
            progressBar.style.width = '0%';
            uploadResult.innerHTML = '';
            
            // Simulate progress (in a real app, you'd use XHR's progress event)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressBar.style.width = `${Math.min(progress, 90)}%`;
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 300);
            
            fetch(`${API_BASE_URL}/documents/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                uploadResult.innerHTML = `<div class="alert alert-success">Document uploaded successfully: ${data.id}</div>`;
                document.getElementById('uploadForm').reset();
                
                // Reload documents list
                setTimeout(() => {
                    loadDocuments();
                }, 1000);
            })
            .catch(error => {
                uploadResult.innerHTML = `<div class="alert alert-danger">Error uploading document: ${error.message}</div>`;
                progressBar.style.width = '0%';
            })
            .finally(() => {
                setTimeout(() => {
                    document.getElementById('uploadProgress').style.display = 'none';
                }, 1000);
            });
        }
        
        // Load documents list
        function loadDocuments(page = 1) {
            const documentsList = document.getElementById('documentsList');
            const pagination = document.getElementById('documentsPagination');
            const collection = document.getElementById('collectionFilter').value;
            
            currentDocumentsPage = page;
            
            documentsList.innerHTML = '<p>Loading documents...</p>';
            pagination.innerHTML = '';
            
            let url = `${API_BASE_URL}/documents?page=${page}&limit=6`;
            if (collection) {
                url += `&collection=${encodeURIComponent(collection)}`;
            }
            
            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.documents.length === 0) {
                    documentsList.innerHTML = '<p>No documents found</p>';
                    return;
                }
                
                documentsList.innerHTML = '';
                
                // Create document cards
                data.documents.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4';
                    card.innerHTML = `
                        <div class="card document-card" data-id="${doc.id}">
                            <div class="card-body">
                                <h5 class="card-title">${doc.title || doc.filename}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${doc.collection || 'No collection'}</h6>
                                <p class="card-text">
                                    Pages: ${doc.page_count}<br>
                                    Uploaded: ${new Date(doc.upload_date).toLocaleDateString()}
                                </p>
                                <button class="btn btn-sm btn-primary view-document">View Details</button>
                            </div>
                        </div>
                    `;
                    documentsList.appendChild(card);
                    
                    // Add click event to view document details
                    card.querySelector('.view-document').addEventListener('click', function() {
                        openDocumentModal(doc.id);
                    });
                });
                
                // Create pagination
                if (data.total_pages > 1) {
                    for (let i = 1; i <= data.total_pages; i++) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === page ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                        li.addEventListener('click', function(e) {
                            e.preventDefault();
                            loadDocuments(i);
                        });
                        pagination.appendChild(li);
                    }
                }
            })
            .catch(error => {
                documentsList.innerHTML = `<p>Error loading documents: ${error.message}</p>`;
            });
        }
        
        // Search documents
        function searchDocuments(page = 1) {
            const searchResults = document.getElementById('searchResults');
            const searchResultsHeading = document.getElementById('searchResultsHeading');
            const pagination = document.getElementById('searchPagination');
            const query = document.getElementById('searchQuery').value;
            const collection = document.getElementById('searchCollection').value;
            
            currentSearchPage = page;
            
            if (!query) {
                searchResults.innerHTML = '<p>Please enter a search query</p>';
                searchResultsHeading.style.display = 'none';
                pagination.innerHTML = '';
                return;
            }
            
            searchResults.innerHTML = '<p>Searching...</p>';
            searchResultsHeading.style.display = 'block';
            pagination.innerHTML = '';
            
            const searchData = {
                text: query,
                page: page,
                limit: 10
            };
            
            if (collection) {
                searchData.collection = collection;
            }
            
            fetch(`${API_BASE_URL}/search`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.total_results === 0) {
                    searchResults.innerHTML = '<p>No results found</p>';
                    return;
                }
                
                searchResults.innerHTML = '';
                
                // Create result items
                data.results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'card mb-3';
                    resultItem.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${result.document_title || result.document_filename}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${result.collection || 'No collection'}</h6>
                            ${result.highlight ? `<p class="card-text">${result.highlight}</p>` : ''}
                            <button class="btn btn-sm btn-primary view-document" data-id="${result.document_id}">View Document</button>
                        </div>
                    `;
                    searchResults.appendChild(resultItem);
                    
                    // Add click event to view document details
                    resultItem.querySelector('.view-document').addEventListener('click', function() {
                        openDocumentModal(result.document_id);
                    });
                });
                
                // Create pagination
                if (data.total_pages > 1) {
                    for (let i = 1; i <= data.total_pages; i++) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === page ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                        li.addEventListener('click', function(e) {
                            e.preventDefault();
                            searchDocuments(i);
                        });
                        pagination.appendChild(li);
                    }
                }
            })
            .catch(error => {
                searchResults.innerHTML = `<p>Error searching documents: ${error.message}</p>`;
            });
        }
        
        // Open document modal
        function openDocumentModal(documentId) {
            currentDocumentId = documentId;
            
            // Reset modal content
            document.getElementById('documentMetadata').innerHTML = 'Loading...';
            document.getElementById('documentText').innerHTML = '';
            document.getElementById('documentTables').innerHTML = '';
            document.getElementById('documentFigures').innerHTML = '';
            document.getElementById('documentSummary').innerHTML = '';
            document.getElementById('documentEntities').innerHTML = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('documentModal'));
            modal.show();
            
            // Load document metadata
            fetch(`${API_BASE_URL}/documents/${documentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const metadataHtml = `
                    <dl class="row">
                        <dt class="col-sm-3">Title</dt>
                        <dd class="col-sm-9">${data.title || 'N/A'}</dd>
                        
                        <dt class="col-sm-3">Author</dt>
                        <dd class="col-sm-9">${data.author || 'N/A'}</dd>
                        
                        <dt class="col-sm-3">Filename</dt>
                        <dd class="col-sm-9">${data.filename}</dd>
                        
                        <dt class="col-sm-3">Collection</dt>
                        <dd class="col-sm-9">${data.collection || 'N/A'}</dd>
                        
                        <dt class="col-sm-3">Pages</dt>
                        <dd class="col-sm-9">${data.page_count}</dd>
                        
                        <dt class="col-sm-3">File Size</dt>
                        <dd class="col-sm-9">${formatFileSize(data.file_size)}</dd>
                        
                        <dt class="col-sm-3">Upload Date</dt>
                        <dd class="col-sm-9">${new Date(data.upload_date).toLocaleString()}</dd>
                        
                        <dt class="col-sm-3">Creation Date</dt>
                        <dd class="col-sm-9">${data.creation_date ? new Date(data.creation_date).toLocaleString() : 'N/A'}</dd>
                        
                        <dt class="col-sm-3">Has Tables</dt>
                        <dd class="col-sm-9">${data.has_tables ? 'Yes' : 'No'}</dd>
                        
                        <dt class="col-sm-3">Has Images</dt>
                        <dd class="col-sm-9">${data.has_images ? 'Yes' : 'No'}</dd>
                    </dl>
                `;
                
                document.getElementById('documentMetadata').innerHTML = metadataHtml;
                document.getElementById('documentModalLabel').textContent = data.title || data.filename;
            })
            .catch(error => {
                document.getElementById('documentMetadata').innerHTML = `<p>Error loading document metadata: ${error.message}</p>`;
            });
        }
        
        // Extract text from document
        function extractText() {
            const pageRange = document.getElementById('pageRange').value;
            const documentText = document.getElementById('documentText');
            
            documentText.innerHTML = 'Extracting text...';
            
            let url = `${API_BASE_URL}/documents/${currentDocumentId}/extract/text`;
            if (pageRange) {
                url += `?pages=${encodeURIComponent(pageRange)}`;
            }
            
            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                documentText.innerHTML = `<pre>${data.text}</pre>`;
            })
            .catch(error => {
                documentText.innerHTML = `<p>Error extracting text: ${error.message}</p>`;
            });
        }
        
        // Extract tables from document
        function extractTables() {
            const pageRange = document.getElementById('tablePageRange').value;
            const format = document.getElementById('tableFormat').value;
            const documentTables = document.getElementById('documentTables');
            
            documentTables.innerHTML = 'Extracting tables...';
            
            let url = `${API_BASE_URL}/documents/${currentDocumentId}/extract/tables?format=${format}`;
            if (pageRange) {
                url += `&pages=${encodeURIComponent(pageRange)}`;
            }
            
            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                if (format === 'json') {
                    return response.json();
                } else {
                    // For CSV and Excel, show download link
                    return response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `tables.${format}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        return { download: true, format: format };
                    });
                }
            })
            .then(data => {
                if (data.download) {
                    documentTables.innerHTML = `<p>Tables downloaded as ${data.format.toUpperCase()}</p>`;
                    return;
                }
                
                if (data.length === 0) {
                    documentTables.innerHTML = '<p>No tables found in the document</p>';
                    return;
                }
                
                documentTables.innerHTML = '';
                
                // Display tables
                data.forEach((table, index) => {
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'mb-4';
                    tableContainer.innerHTML = `<h5>Table ${index + 1} (Page ${table.page})</h5>`;
                    
                    const tableElement = document.createElement('table');
                    tableElement.className = 'table table-bordered table-sm';
                    
                    // Create header row
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    table.headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    tableElement.appendChild(thead);
                    
                    // Create data rows
                    const tbody = document.createElement('tbody');
                    table.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        table.headers.forEach(header => {
                            const td = document.createElement('td');
                            td.textContent = row[header] || '';
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    tableElement.appendChild(tbody);
                    
                    tableContainer.appendChild(tableElement);
                    documentTables.appendChild(tableContainer);
                });
            })
            .catch(error => {
                documentTables.innerHTML = `<p>Error extracting tables: ${error.message}</p>`;
            });
        }
        
        // Generate document summary
        function generateSummary() {
            const maxLength = document.getElementById('summaryLength').value;
            const documentSummary = document.getElementById('documentSummary');
            
            documentSummary.innerHTML = 'Generating summary...';
            
            fetch(`${API_BASE_URL}/documents/${currentDocumentId}/analyze/summary?max_length=${maxLength}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                documentSummary.innerHTML = data.summary;
            })
            .catch(error => {
                documentSummary.innerHTML = `<p>Error generating summary: ${error.message}</p>`;
            });
        }
        
        // Extract entities from document
        function extractEntities() {
            const documentEntities = document.getElementById('documentEntities');
            
            documentEntities.innerHTML = 'Extracting entities...';
            
            fetch(`${API_BASE_URL}/documents/${currentDocumentId}/analyze/entities`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.entities.length === 0) {
                    documentEntities.innerHTML = '<p>No entities found in the document</p>';
                    return;
                }
                
                // Group entities by label
                const entityGroups = {};
                data.entities.forEach(entity => {
                    if (!entityGroups[entity.label]) {
                        entityGroups[entity.label] = [];
                    }
                    entityGroups[entity.label].push(entity);
                });
                
                // Display entities by group
                documentEntities.innerHTML = '';
                
                for (const [label, entities] of Object.entries(entityGroups)) {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mb-4';
                    groupContainer.innerHTML = `<h5>${label}</h5>`;
                    
                    const table = document.createElement('table');
                    table.className = 'table table-sm';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Entity</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    
                    const tbody = table.querySelector('tbody');
                    
                    // Sort entities by count (descending)
                    entities.sort((a, b) => b.count - a.count);
                    
                    entities.forEach(entity => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entity.text}</td>
                            <td>${entity.count}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    groupContainer.appendChild(table);
                    documentEntities.appendChild(groupContainer);
                }
            })
            .catch(error => {
                documentEntities.innerHTML = `<p>Error extracting entities: ${error.message}</p>`;
            });
        }
        
        // Delete document
        function deleteDocument() {
            if (!confirm(`Are you sure you want to delete this document?`)) {
                return;
            }
            
            fetch(`${API_BASE_URL}/documents/${currentDocumentId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentModal'));
                modal.hide();
                
                // Reload documents list
                loadDocuments(currentDocumentsPage);
                
                // Show success message
                alert('Document deleted successfully');
            })
            .catch(error => {
                alert(`Error deleting document: ${error.message}`);
            });
        }
        
        // Translate document
        function translateDocument() {
            const targetLanguage = document.getElementById('translateLanguage').value;
            const documentTranslation = document.getElementById('documentTranslation');
            
            documentTranslation.innerHTML = '<p>Translating document... This may take a while for large documents.</p>';
            
            fetch(`${API_BASE_URL}/documents/${currentDocumentId}/translate?target_language=${targetLanguage}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                let statusHtml = '';
                
                if (data.cached) {
                    statusHtml = '<p><em>(Loaded from cache)</em></p>';
                } else if (data.skipped) {
                    statusHtml = '<p><em>(Translation skipped - document already in target language)</em></p>';
                }
                
                documentTranslation.innerHTML = `
                    <div class="mb-3">
                        <p><strong>Original Language:</strong> ${data.source_language}</p>
                        <p><strong>Translated to:</strong> ${data.target_language}</p>
                        ${statusHtml}
                    </div>
                    <pre>${data.translated_text}</pre>
                `;
            })
            .catch(error => {
                documentTranslation.innerHTML = `<p class="text-danger">Error translating document: ${error.message}</p>`;
            });
        }
        
        // Translate specific pages
        function translatePages() {
            const targetLanguage = document.getElementById('translateLanguage').value;
            const pageRange = document.getElementById('translatePageRange').value;
            const documentTranslation = document.getElementById('documentTranslation');
            
            documentTranslation.innerHTML = '<p>Translating pages... This may take a while.</p>';
            
            let url = `${API_BASE_URL}/documents/${currentDocumentId}/translate/pages?target_language=${targetLanguage}`;
            if (pageRange) {
                url += `&pages=${encodeURIComponent(pageRange)}`;
            }
            
            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                let translationHtml = `
                    <div class="mb-3">
                        <p><strong>Pages Translated:</strong> ${data.page_count}</p>
                        <p><strong>Target Language:</strong> ${data.target_language}</p>
                    </div>
                `;
                
                // Display translations for each page
                for (const [pageNum, translation] of Object.entries(data.translations)) {
                    let pageStatusHtml = '';
                    
                    if (translation.cached) {
                        pageStatusHtml = '<em>(Loaded from cache)</em>';
                    } else if (translation.skipped) {
                        pageStatusHtml = '<em>(Translation skipped - already in target language)</em>';
                    } else if (translation.error) {
                        pageStatusHtml = `<span class="text-danger">(Error: ${translation.error})</span>`;
                    }
                    
                    translationHtml += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Page ${pageNum}</strong> 
                                ${pageStatusHtml}
                                ${translation.source_language ? `<span class="ms-2">From: ${translation.source_language}</span>` : ''}
                            </div>
                            <div class="card-body">
                                <pre>${translation.translated_text || 'No text available'}</pre>
                            </div>
                        </div>
                    `;
                }
                
                documentTranslation.innerHTML = translationHtml;
            })
            .catch(error => {
                documentTranslation.innerHTML = `<p class="text-danger">Error translating pages: ${error.message}</p>`;
            });
        }
        
        // Extract figures from document
        function extractFigures() {
            const pageRange = document.getElementById('figurePageRange').value;
            const format = document.getElementById('figureFormat').value;
            const imageFormat = document.getElementById('imageFormat').value;
            const documentFigures = document.getElementById('documentFigures');
            
            documentFigures.innerHTML = 'Extracting figures...';
            
            let url = `${API_BASE_URL}/documents/${currentDocumentId}/extract/figures?format=${format}&image_format=${imageFormat}`;
            if (pageRange) {
                url += `&pages=${encodeURIComponent(pageRange)}`;
            }
            
            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                if (format === 'json') {
                    return response.json();
                } else {
                    // For ZIP, show download link
                    return response.blob().then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `figures.zip`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        return { download: true, format: format };
                    });
                }
            })
            .then(data => {
                if (data.download) {
                    documentFigures.innerHTML = `<p>Figures downloaded as ${data.format.toUpperCase()}</p>`;
                    return;
                }
                
                if (data.length === 0) {
                    documentFigures.innerHTML = '<p>No figures found in the document</p>';
                    return;
                }
                
                documentFigures.innerHTML = '';
                
                // Display figures
                data.forEach((figure, index) => {
                    const figureCol = document.createElement('div');
                    figureCol.className = 'col-md-4 mb-4';
                    
                    const figureCard = document.createElement('div');
                    figureCard.className = 'card';
                    
                    // Create figure image
                    const img = document.createElement('img');
                    img.className = 'card-img-top';
                    img.src = `${API_BASE_URL}${figure.url}`;
                    img.alt = `Figure ${figure.figure} from page ${figure.page}`;
                    
                    // Create figure info
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    cardBody.innerHTML = `
                        <h5 class="card-title">Figure ${figure.figure}</h5>
                        <p class="card-text">
                            Page: ${figure.page}<br>
                            Size: ${figure.width}x${figure.height}
                        </p>
                        <a href="${API_BASE_URL}${figure.url}" class="btn btn-sm btn-primary" target="_blank">View Full Size</a>
                    `;
                    
                    figureCard.appendChild(img);
                    figureCard.appendChild(cardBody);
                    figureCol.appendChild(figureCard);
                    documentFigures.appendChild(figureCol);
                });
            })
            .catch(error => {
                documentFigures.innerHTML = `<p>Error extracting figures: ${error.message}</p>`;
            });
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
